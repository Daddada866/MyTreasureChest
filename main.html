<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MyTreasureChest â€” Bloom DeFi Saving</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f1419;
      --surface: #1a2229;
      --panel: #232d38;
      --border: #3d4a58;
      --text: #e8ecf0;
      --muted: #7a8a9a;
      --gold: #e8b84a;
      --gold-dim: #c49b3a;
      --green: #5cb88a;
      --amber: #d4a03a;
      --radius: 10px;
      --font-serif: "Playfair Display", Georgia, serif;
      --font-mono: "JetBrains Mono", monospace;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-serif);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      background-image:
        radial-gradient(ellipse 80% 40% at 50% -10%, rgba(232, 184, 74, 0.08), transparent 50%),
        radial-gradient(ellipse 60% 50% at 80% 90%, rgba(92, 184, 138, 0.06), transparent 45%);
    }
    .app {
      max-width: 720px;
      margin: 0 auto;
      padding: 1.5rem;
      min-height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1.5rem;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }
    .logo-emoji { font-size: 1.8rem; }
    .logo-text {
      font-weight: 700;
      font-size: 1.35rem;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--gold), var(--green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .tagline { font-size: 0.75rem; color: var(--muted); margin-top: 0.1rem; }
    .wallet-row { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
    .addr { font-family: var(--font-mono); font-size: 0.8rem; color: var(--muted); max-width: 140px; overflow: hidden; text-overflow: ellipsis; }
    .btn {
      font-family: var(--font-serif);
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
    }
    .btn:hover { background: var(--surface); border-color: var(--gold); }
    .btn-primary {
      background: linear-gradient(135deg, #a67c2e, var(--gold));
      border-color: var(--gold);
      color: #0f1419;
    }
    .btn-primary:hover { box-shadow: 0 0 18px rgba(232, 184, 74, 0.35); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .card h2 {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      color: var(--gold);
    }
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .stat {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.6rem;
      text-align: center;
    }
    .stat-label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .stat-value { font-family: var(--font-mono); font-size: 0.9rem; margin-top: 0.2rem; }
    input[type="text"], input[type="number"] {
      width: 100%;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      margin-bottom: 0.5rem;
    }
    input::placeholder { color: var(--muted); }
    label { display: block; font-size: 0.78rem; color: var(--muted); margin-bottom: 0.25rem; }
    .form-row { margin-bottom: 0.65rem; }
    .msg { font-size: 0.85rem; padding: 0.5rem; border-radius: var(--radius); margin-top: 0.5rem; }
    .msg.err { background: rgba(239, 68, 68, 0.12); color: #f87171; }
    .msg.ok { background: rgba(92, 184, 138, 0.12); color: var(--green); }
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .tab {
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      cursor: pointer;
      font-weight: 600;
    }
    .tab.active { background: var(--panel); color: var(--gold); border-color: var(--gold); }
    .tab:hover:not(.active) { color: var(--text); }
    .tab-content { display: none; }
    .tab-content.visible { display: block; }
    .tier-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      margin-top: 0.75rem;
    }
    .tier-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.75rem;
      font-size: 0.8rem;
    }
    .tier-card .name { color: var(--gold); font-weight: 600; }
    .tier-card .blocks { font-family: var(--font-mono); color: var(--muted); font-size: 0.75rem; margin-top: 0.25rem; }
    .tier-card .seeds { font-family: var(--font-mono); color: var(--green); margin-top: 0.2rem; }
    .chest-list { margin-top: 0.75rem; }
    .chest-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.85rem;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }
    .chest-item .row { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.35rem; }
    .chest-item .id { font-family: var(--font-mono); color: var(--muted); }
    .chest-item .balance { color: var(--green); font-family: var(--font-mono); }
    .chest-item .yield { color: var(--amber); font-family: var(--font-mono); }
    .chest-item .unlock { font-family: var(--font-mono); font-size: 0.78rem; color: var(--muted); }
    .chest-item.locked .unlock { color: #e07c6b; }
    .chest-item .actions { margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .summary-row { display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
    .summary-row:last-child { border-bottom: none; }
    .list-compact { font-family: var(--font-mono); font-size: 0.8rem; color: var(--muted); }
    .list-compact div { padding: 0.35rem 0; border-bottom: 1px solid var(--border); }
    .list-compact div:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">
        <span class="logo-emoji">ðŸ“¦</span>
        <div>
          <div class="logo-text">MyTreasureChest</div>
          <div class="tagline">Bloom â€” put your assets to work</div>
        </div>
      </div>
      <div class="wallet-row">
        <span id="wallet-addr" class="addr">â€”</span>
        <button id="btn-connect" class="btn">Connect</button>
      </div>
    </header>

    <div class="card">
      <h2>Bloom contract</h2>
      <div class="form-row">
        <label>Bloom contract address</label>
        <input type="text" id="contract-address" placeholder="0xâ€¦" />
      </div>
      <button id="btn-set-contract" class="btn btn-primary">Set contract</button>
      <div id="contract-msg"></div>
    </div>

    <div class="card">
      <h2>Garden stats</h2>
      <div class="stats-row">
        <div class="stat"><div class="stat-label">Total staked</div><div id="stat-staked" class="stat-value">â€”</div></div>
        <div class="stat"><div class="stat-label">Yield distributed</div><div id="stat-yield" class="stat-value">â€”</div></div>
        <div class="stat"><div class="stat-label">Treasury</div><div id="stat-treasury" class="stat-value">â€”</div></div>
        <div class="stat"><div class="stat-label">Pending harvest</div><div id="stat-pending" class="stat-value">â€”</div></div>
        <div class="stat"><div class="stat-label">Paused</div><div id="stat-paused" class="stat-value">â€”</div></div>
      </div>
      <button id="btn-refresh-stats" class="btn">Refresh</button>
    </div>

    <div class="card">
      <h2>Lock tiers</h2>
      <p style="font-size:0.8rem; color: var(--muted); margin-bottom: 0.5rem;">Longer locks earn higher yield weight.</p>
      <div id="tiers-container" class="tier-grid"></div>
    </div>

    <div class="card">
      <h2>My chests &amp; balance</h2>
      <div id="my-summary" class="summary-row" style="display:block; padding:0.5rem 0;">
        <div class="summary-row"><span>Total saved</span><span id="sum-total-saved" class="balance">â€”</span></div>
        <div class="summary-row"><span>Pending yield</span><span id="sum-pending-yield" class="yield">â€”</span></div>
        <div class="summary-row"><span>Active chests</span><span id="sum-chest-count">â€”</span></div>
      </div>
      <button id="btn-load-chests" class="btn">Load my chests</button>
      <div id="chests-container" class="chest-list"></div>
    </div>

    <div class="card">
      <h2>Actions</h2>
      <div class="tabs">
        <button class="tab active" data-tab="open">Open chest</button>
        <button class="tab" data-tab="seed">Deposit</button>
        <button class="tab" data-tab="withdraw">Withdraw</button>
      </div>

      <div id="panel-open" class="tab-content visible">
        <div class="form-row">
          <label>Tier index (0 = shortest lock, 5 = longest)</label>
          <input type="number" id="open-tier" placeholder="0" min="0" max="7" value="0" />
        </div>
        <button id="btn-open-chest" class="btn btn-primary">Open chest</button>
      </div>

      <div id="panel-seed" class="tab-content">
        <div class="form-row">
          <label>Chest ID (your chest number)</label>
          <input type="number" id="seed-chest-id" placeholder="0" min="0" />
        </div>
        <div class="form-row">
          <label>Amount (ETH)</label>
          <input type="text" id="seed-amount" placeholder="0.01" />
        </div>
        <button id="btn-seed" class="btn btn-primary">Deposit into chest</button>
      </div>

      <div id="panel-withdraw" class="tab-content">
        <div class="form-row">
          <label>Chest ID to withdraw (must be unlocked)</label>
          <input type="number" id="withdraw-chest-id" placeholder="0" min="0" />
        </div>
        <button id="btn-withdraw" class="btn btn-primary">Withdraw chest</button>
      </div>

      <div id="action-msg" class="msg" style="margin-top:0.75rem;"></div>
    </div>

    <div class="card">
      <h2>How it works</h2>
      <p style="font-size:0.85rem; color: var(--muted); margin-bottom: 0.5rem;">Bloom is a DeFi saving platform that puts your assets to work.</p>
      <ul style="font-size:0.85rem; color: var(--text); padding-left: 1.25rem; line-height: 1.7;">
        <li><strong>Open a chest</strong> â€” Choose a lock tier (0 = shortest, 5 = longest). Longer locks earn a higher share of yield.</li>
        <li><strong>Deposit (seed)</strong> â€” Send ETH into your chest. Your principal is locked until the unlock block.</li>
        <li><strong>Yield</strong> â€” A keeper harvests yield and allocates it to tiers by weight. Your chest accrues yield until you withdraw.</li>
        <li><strong>Withdraw</strong> â€” After the lock period (unlock block), withdraw your principal plus accrued yield in one tx.</li>
      </ul>
      <p style="font-size:0.8rem; color: var(--muted); margin-top: 0.75rem;">Set the Bloom contract address above (deploy from bloom.sol), connect your wallet, then open chests and start saving.</p>
      <p style="font-size:0.78rem; color: var(--muted); margin-top: 0.5rem;">Each chest has a fixed lock period (in blocks). You can open multiple chests in different tiers. Deposit into any chest anytime before withdrawal. Yield is distributed by the keeper via harvest and allocateHarvest; longer lock tiers receive a larger share of each harvest.</p>
    </div>

    <div class="card">
      <h2>Network &amp; contract</h2>
      <div class="stats-row">
        <div class="stat"><div class="stat-label">Chain ID</div><div id="stat-chain" class="stat-value">â€”</div></div>
        <div class="stat"><div class="stat-label">Contract set</div><div id="stat-contract-set" class="stat-value">â€”</div></div>
      </div>
      <p style="font-size:0.78rem; color: var(--muted);">Ensure you are on the same network as the deployed Bloom contract.</p>
    </div>

    <div class="card">
      <h2>Quick tips</h2>
      <ul style="font-size:0.82rem; color: var(--muted); padding-left: 1.25rem; line-height: 1.6;">
        <li>After opening a chest, note the chest ID (shown in My chests) for deposits.</li>
        <li>Deposit (seed) sends ETH in one tx; use the Deposit tab and enter chest ID and amount.</li>
        <li>Withdraw is only available after the lock period; Load my chests shows which are unlocked.</li>
        <li>Global stats update when you click Refresh.</li>
      </ul>
    </div>
  </div>

  <script>
    (function() {
      const BLOOM_ABI = [
        "function openChest(uint8 tierIndex) external returns (uint256 chestId)",
        "function seed(uint256 chestId) external payable",
        "function withdraw(uint256 chestId) external",
        "function getGlobalStats() external view returns (uint256 totalStaked, uint256 totalYield, uint256 treasuryBal, uint256 pendingHarvest)",
        "function getTiersBatch(uint8 fromIndex, uint8 toIndex) external view returns (uint256[] memory lockBlocksArr, uint256[] memory weightNumerators, uint256[] memory totalSeedsInTierArr, uint256[] memory accumulatedYieldScaledArr, bool[] memory existsArr)",
        "function tierCount() external view returns (uint8)",
        "function getUserSummary(address user) external view returns (uint256 totalSeeds, uint256 totalPendingYield, uint256 activeChestCount)",
        "function getChestsFullForUser(address user) external view returns (uint256[] memory chestIds, uint8[] memory tierIndices, uint256[] memory seedBalances, uint256[] memory unlockBlocks, uint256[] memory pendingYields)",
        "function blocksUntilUnlock(address user, uint256 chestId) external view returns (uint256)",
        "function isPaused() external view returns (bool)"
      ];

      let provider, signer, contractAddress = "", contract = null;

      const walletEl = document.getElementById("wallet-addr");
      const btnConnect = document.getElementById("btn-connect");
      const contractInput = document.getElementById("contract-address");
      const btnSetContract = document.getElementById("btn-set-contract");
      const contractMsg = document.getElementById("contract-msg");
      const actionMsg = document.getElementById("action-msg");
      const statStaked = document.getElementById("stat-staked");
      const statYield = document.getElementById("stat-yield");
      const statTreasury = document.getElementById("stat-treasury");
      const statPending = document.getElementById("stat-pending");
      const statPaused = document.getElementById("stat-paused");
      const tiersContainer = document.getElementById("tiers-container");
      const chestsContainer = document.getElementById("chests-container");
      const sumTotalSaved = document.getElementById("sum-total-saved");
      const sumPendingYield = document.getElementById("sum-pending-yield");
      const sumChestCount = document.getElementById("sum-chest-count");

      function showMsg(container, text, type) {
        container.innerHTML = text ? "<div class=\"msg " + type + "\">" + text + "</div>" : "";
      }

      function formatEth(wei) {
        if (wei === undefined || wei === null) return "â€”";
        const w = typeof wei === "bigint" ? wei : BigInt(wei);
        if (w === 0n) return "0";
        const s = w.toString();
        if (s.length <= 18) return "0." + s.padStart(18, "0").slice(0, 6);
        const intPart = s.slice(0, -18);
        const decPart = s.slice(-18).slice(0, 6);
        return intPart + "." + decPart;
      }

      document.querySelectorAll(".tab").forEach(function(tab) {
        tab.addEventListener("click", function() {
          document.querySelectorAll(".tab").forEach(function(t) { t.classList.remove("active"); });
          document.querySelectorAll(".tab-content").forEach(function(c) { c.classList.remove("visible"); });
          tab.classList.add("active");
          var panel = document.getElementById("panel-" + tab.dataset.tab);
          if (panel) panel.classList.add("visible");
        });
      });

      btnSetContract.addEventListener("click", function() {
        var addr = (contractInput.value || "").trim();
        if (!addr || !addr.startsWith("0x")) {
          showMsg(contractMsg, "Enter a valid contract address (0xâ€¦).", "err");
          return;
        }
        contractAddress = addr;
        contract = new ethers.Contract(addr, BLOOM_ABI, signer || provider);
        showMsg(contractMsg, "Contract set.", "ok");
        document.getElementById("stat-contract-set").textContent = "Yes";
        refreshStats();
        loadTiers();
      });

      async function connect() {
        if (typeof window.ethereum === "undefined") {
          showMsg(contractMsg, "Install MetaMask or another Web3 wallet.", "err");
          return;
        }
        try {
          provider = new ethers.BrowserProvider(window.ethereum);
          var accounts = await provider.send("eth_requestAccounts", []);
          if (!accounts.length) return;
          signer = await provider.getSigner();
          var addr = await signer.getAddress();
          walletEl.textContent = addr.slice(0, 6) + "â€¦" + addr.slice(-4);
          btnConnect.textContent = "Connected";
          btnConnect.disabled = true;
          if (provider) {
            var net = await provider.getNetwork();
            document.getElementById("stat-chain").textContent = net ? net.chainId.toString() : "â€”";
          }
          document.getElementById("stat-contract-set").textContent = contractAddress ? "Yes" : "No";
          if (contractAddress) {
            contract = new ethers.Contract(contractAddress, BLOOM_ABI, signer);
            refreshStats();
            loadTiers();
            loadMySummary();
          }
        } catch (e) {
          showMsg(contractMsg, e.message || "Connection failed.", "err");
        }
      }

      btnConnect.addEventListener("click", connect);

      async function refreshStats() {
        if (!contract) return;
        try {
          var [totalStaked, totalYield, treasuryBal, pendingHarvest] = await contract.getGlobalStats();
          statStaked.textContent = formatEth(totalStaked) + " ETH";
          statYield.textContent = formatEth(totalYield) + " ETH";
          statTreasury.textContent = formatEth(treasuryBal) + " ETH";
          statPending.textContent = formatEth(pendingHarvest) + " ETH";
          var paused = await contract.isPaused();
          statPaused.textContent = paused ? "Yes" : "No";
        } catch (e) {
          statStaked.textContent = statYield.textContent = statTreasury.textContent = statPending.textContent = "â€”";
          statPaused.textContent = "â€”";
        }
      }

      document.getElementById("btn-refresh-stats").addEventListener("click", function() {
        refreshStats();
        loadTiers();
        loadMySummary();
      });

      async function loadTiers() {
        if (!contract) return;
        tiersContainer.innerHTML = "";
        try {
          var count = await contract.tierCount();
          if (Number(count) === 0) {
            tiersContainer.innerHTML = "<p style=\"color:var(--muted); font-size:0.85rem;\">No tiers.</p>";
            return;
          }
          var [lockBlocksArr, weightNumerators, totalSeedsInTierArr] = await contract.getTiersBatch(0, count);
          var names = ["~32m", "~1h", "~4h", "~17h", "~2.8d", "~11d", "Tier 6", "Tier 7"];
          for (var i = 0; i < lockBlocksArr.length; i++) {
            var div = document.createElement("div");
            div.className = "tier-card";
            div.innerHTML =
              "<div class=\"name\">Tier " + i + " " + (names[i] || "") + "</div>" +
              "<div class=\"blocks\">Lock: " + lockBlocksArr[i].toString() + " blocks</div>" +
              "<div class=\"seeds\">Seeds: " + formatEth(totalSeedsInTierArr[i]) + " ETH</div>";
            tiersContainer.appendChild(div);
          }
        } catch (e) {
          tiersContainer.innerHTML = "<p class=\"msg err\">" + (e.message || "Failed to load tiers") + "</p>";
        }
      }

      async function loadMySummary() {
        if (!contract || !signer) return;
        try {
          var addr = await signer.getAddress();
          var [totalSeeds, totalPendingYield, activeChestCount] = await contract.getUserSummary(addr);
          sumTotalSaved.textContent = formatEth(totalSeeds) + " ETH";
          sumPendingYield.textContent = formatEth(totalPendingYield) + " ETH";
          sumChestCount.textContent = activeChestCount.toString();
        } catch (e) {
          sumTotalSaved.textContent = sumPendingYield.textContent = sumChestCount.textContent = "â€”";
        }
      }

      document.getElementById("btn-load-chests").addEventListener("click", async function() {
        if (!contract || !signer) {
          showMsg(actionMsg, "Connect wallet and set contract first.", "err");
